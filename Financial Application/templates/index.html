<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Goals & Journal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <!-- Financial Status Overview Widget -->
            <div class="sidebar-financial-overview">
                <div class="financial-status-icon" id="sidebar-status-icon">üíº</div>
                <div class="financial-status-text" id="sidebar-status-text">Loading...</div>
                <div class="financial-quick-stats">
                    <div class="quick-stat">
                        <span class="quick-stat-value" id="sidebar-goals-completed">-</span>
                        <span class="quick-stat-label">Goals</span>
                    </div>
                    <div class="quick-stat">
                        <span class="quick-stat-value" id="sidebar-budget-status">-</span>
                        <span class="quick-stat-label">Budget</span>
                    </div>
                    <div class="quick-stat">
                        <span class="quick-stat-value" id="sidebar-recent-activity">-</span>
                        <span class="quick-stat-label">Activity</span>
                    </div>
                </div>
            </div>

            <!-- Keep existing calendar code -->
            <div class="calendar" role="region" aria-label="Calendar">
                <div class="month">
                    <ul>
                        <li class="prev" onclick="prevMonth()">&#10094;</li>
                        <li class="next" onclick="nextMonth()">&#10095;</li>
                        <li id="monthYear"><!-- Month and year populated by JS --></li>
                    </ul>
                </div>
                <ul class="weekdays">
                    <li>Mo</li>
                    <li>Tu</li>
                    <li>We</li>
                    <li>Th</li>
                    <li>Fr</li>
                    <li>Sa</li>
                    <li>Su</li>
                </ul>
                <!-- Calendar days - populated by JavaScript -->
                <ul class="days">
                    {% for day in days %}
                        <li class="{{ 'entry-day' if day in entry_days else '' }}">{{ day }}</li>
                    {% endfor %}
                </ul>
            </div>
            
            <nav>
                <ul>
                    <li><a href="{{ url_for('home') }}" class="active">Dashboard</a></li>
                    <li><a href="{{ url_for('view_goals') }}">Goals</a></li>
                    <li><a href="{{ url_for('view_budget') }}">Budget</a></li>
                    <li><a href="{{ url_for('view_journal') }}">Journal</a></li>
                </ul>
            </nav>

            <!-- Quick Actions Widget -->
            <div class="sidebar-quick-actions">
                <h3>Quick Actions</h3>
                <div class="quick-action-buttons">
                    <a href="{{ url_for('add_goal') }}" class="quick-action-btn">‚ûï Add Goal</a>
                    <a href="{{ url_for('add_expense') }}" class="quick-action-btn secondary">üí∏ Add Expense</a>
                    <a href="{{ url_for('add_entry') }}" class="quick-action-btn">üìù Journal Entry</a>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <h1>Financial Dashboard</h1>
            
            <div class="welcome-message">
                <h2>Welcome! <span id="status-icon">üéØ</span></h2>
                <p id="status-text">Here's an overview of your financial goals and recent updates.</p>
                <div class="financial-status" id="financial-status">
                    <div class="status-indicator">
                        <span class="status-emoji" id="status-emoji">üìä</span>
                        <span class="status-message" id="status-message">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Goals Overview -->
            <section class="goals-overview">
                <h2>Your Financial Goals</h2>
                {% if goals %}
                    {% for goal in goals %}
                    <div class="goal-card">
                        <h3>{{ goal[1] }}</h3>
                        <div class="goal-stats">
                            <span class="category-badge {{ goal[5] }}">{{ goal[5].title() }}</span>
                            <span class="deadline">Due: {{ goal[4] }}</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ (goal[3] / goal[2] * 100)|round }}%"></div>
                            </div>
                            <span class="progress-text">{{ '${:,.2f}'.format(goal[3]) }} / {{ '${:,.2f}'.format(goal[2]) }} ({{ (goal[3] / goal[2] * 100)|round }}%)</span>
                        </div>
                        
                        <!-- Quick Update Form -->
                        <form class="update-form" data-goal-id="{{ goal[0] }}">
                            <div class="form-group">
                                <input type="number" step="0.01" name="amount" placeholder="Amount" required>
                                <select name="type" required>
                                    <option value="deposit">Add</option>
                                    <option value="withdrawal">Subtract</option>
                                </select>
                                <button type="submit">Update</button>
                            </div>
                            <div class="error-message" style="display:none;"></div>
                        </form>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-goals">
                        <p>No financial goals yet. <a href="{{ url_for('add_goal') }}">Create your first goal!</a></p>
                    </div>
                {% endif %}
            </section>
            
            <!-- Recent Transactions -->
            <section class="recent-transactions">
                <h2>Recent Updates</h2>
                <div class="transactions-list">
                    {% for trans in transactions %}
                    <div class="transaction-item">
                        <span class="date">{{ trans[0] }}</span>
                        <span class="amount {{ trans[2] }}">{{ trans[1] }}</span>
                        <span class="goal-name">{{ trans[3] }}</span>
                    </div>
                    {% endfor %}
                </div>
            </section>
            
            <!-- Financial Health Overview -->
            <section class="financial-health">
                <h2>Financial Health Score</h2>
                <div class="health-score">
                    <div class="score-circle">
                        <div class="score-text">{{ '{:.0f}'.format(goal_score) }}%</div>
                        <div class="score-label">Goals Progress</div>
                    </div>
                    <div class="health-tips">
                        {% if goal_score >= 80 %}
                            <p class="tip success">üéâ Excellent progress! Keep up the great work!</p>
                        {% elif goal_score >= 60 %}
                            <p class="tip good">üëç Good progress! You're on the right track.</p>
                        {% elif goal_score >= 40 %}
                            <p class="tip warning">‚ö†Ô∏è Making progress, but there's room for improvement.</p>
                        {% else %}
                            <p class="tip danger">üö® Time to focus on your financial goals!</p>
                        {% endif %}
                    </div>
                </div>
            </section>
            
            <!-- Budget Overview -->
            {% if budget_overview %}
            <section class="budget-summary">
                <h2>This Month's Budget</h2>
                <div class="budget-grid">
                    {% for budget in budget_overview %}
                    <div class="budget-item">
                        <h4>{{ budget[0].title() }}</h4>
                        <div class="budget-bar">
                            <div class="budget-progress" 
                                 style="width: {{ [budget[3], 100]|min }}%"
                                 class="{{ 'over-budget' if budget[3] > 100 else 'on-track' }}"></div>
                        </div>
                        <p>${{ '{:,.0f}'.format(budget[2]) }} / ${{ '{:,.0f}'.format(budget[1]) }}</p>
                    </div>
                    {% endfor %}
                </div>
                <a href="{{ url_for('view_budget') }}" class="view-all-link">View Full Budget ‚Üí</a>
            </section>
            {% endif %}
            
        </div>
        
        <!-- Theme Toggle Button -->
        <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark/light mode">
            <span class="sun-icon">‚òÄÔ∏è</span>
            <span class="moon-icon">üåô</span>
        </button>
    </div>      
    <!-- JavaScript for calendar functionality -->
    <script>
        // Calendar variables
        const currentDate = new Date();
        let selectedDate = new Date();
        // Get days with entries from Flask
        const entryDays = JSON.parse('{{ entry_days|tojson|safe }}'); 

        /**
         * Renders the calendar for the current month
         * Highlights today and days with entries
         */
        function renderCalendar() {
            const monthYearDisplay = document.getElementById('monthYear');
            const daysContainer = document.querySelector('.days');
            daysContainer.innerHTML = '';

            const month = selectedDate.getMonth();
            const year = selectedDate.getFullYear();
            
            // Display month and year
            monthYearDisplay.innerHTML = `${selectedDate.toLocaleString('default', { month: 'long' })}<br><span style="font-size:18px">${year}</span>`;

            // Calculate first day and last date of month
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const lastDateOfMonth = new Date(year, month + 1, 0).getDate();

            // Create day elements
            for (let i = 1; i <= lastDateOfMonth; i++) {
                const dayElement = document.createElement('li');
                dayElement.innerText = i;
                
                // Highlight today
                if (i === currentDate.getDate() && 
                    month === currentDate.getMonth() && 
                    year === currentDate.getFullYear()) {
                    dayElement.classList.add('current-day');
                }
                
                // Highlight days with entries
                if (entryDays.includes(i)) {
                    dayElement.classList.add('entry-day');
                }
                
                // Make days clickable
                dayElement.onclick = () => selectDate(i);
                daysContainer.appendChild(dayElement);
            }
        }

        /**
         * Handles date selection in the calendar
         */
        async function selectDate(day) {
            try {
                selectedDate.setDate(day);
                const formattedDate = selectedDate.toISOString().split('T')[0];
                const response = await fetch(`/entries/${formattedDate}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.entries && data.entries.length > 0) {
                        window.location.href = `/view_entries?date=${formattedDate}`;
                    } else {
                        window.location.href = `/add_entry?date=${formattedDate}`;
                    }
                } else {
                    showNotification('Error', 'Failed to check entries for selected date');
                }
            } catch (error) {
                showNotification('Error', 'Failed to process date selection');
            }
        }

        /**
         * Navigate to previous month
         */
        function prevMonth() {
            selectedDate.setMonth(selectedDate.getMonth() - 1);
            renderCalendar();
        }

        /**
         * Navigate to next month
         */
        function nextMonth() {
            selectedDate.setMonth(selectedDate.getMonth() + 1);
            renderCalendar();
        }

        // Initialize calendar on page load
        renderCalendar();
    </script>
    
    <!-- Main application JavaScript -->
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
    <script>
// Handle journal form submission
document.getElementById('journalForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    try {
        const response = await fetch('/save', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            showNotification('Success', data.message);
            this.reset();
            // Refresh calendar to show new entry
            renderCalendar();
        }
    } catch (error) {
        showNotification('Error', 'Failed to save entry');
    }
});

// Handle goal updates
document.querySelectorAll('.update-form').forEach(form => {
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const goalId = this.dataset.goalId;
        const formData = new FormData(this);
        const errorDiv = this.querySelector('.error-message');
        
        try {
            const response = await fetch(`/update_goal/${goalId}`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            if (data.success) {
                showNotification('Success', data.message);
                this.reset();
                // Refresh page to show updated goals
                window.location.reload();
            } else {
                errorDiv.textContent = data.message;
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            errorDiv.textContent = 'Failed to update goal';
            errorDiv.style.display = 'block';
        }
    });
});
</script>
<script>
        // Load financial status for both main dashboard and sidebar
        async function loadFinancialStatus() {
            try {
                const response = await fetch('/api/financial_status');
                const data = await response.json();
                
                // Update main dashboard status
                const statusEmoji = document.getElementById('status-emoji');
                const statusMessage = document.getElementById('status-message');
                const statusIcon = document.getElementById('status-icon');
                
                if (statusEmoji) statusEmoji.textContent = data.status_icon;
                if (statusMessage) statusMessage.textContent = data.status_text;
                if (statusIcon) statusIcon.textContent = data.status_icon;
                
                // Update sidebar financial overview
                const sidebarStatusIcon = document.getElementById('sidebar-status-icon');
                const sidebarStatusText = document.getElementById('sidebar-status-text');
                const sidebarGoalsCompleted = document.getElementById('sidebar-goals-completed');
                const sidebarBudgetStatus = document.getElementById('sidebar-budget-status');
                const sidebarRecentActivity = document.getElementById('sidebar-recent-activity');
                
                if (sidebarStatusIcon) sidebarStatusIcon.textContent = data.status_icon;
                if (sidebarStatusText) sidebarStatusText.textContent = data.status_text;
                if (sidebarGoalsCompleted) sidebarGoalsCompleted.textContent = `${data.completed_goals}/${data.total_goals}`;
                if (sidebarBudgetStatus) sidebarBudgetStatus.textContent = `${data.budget_utilization.toFixed(0)}%`;
                if (sidebarRecentActivity) sidebarRecentActivity.textContent = data.recent_activity;
                
                // Update status text based on financial health
                const statusParagraph = document.getElementById('status-text');
                if (statusParagraph) {
                    if (data.goal_completion_rate >= 80) {
                        statusParagraph.textContent = "You're crushing your financial goals! Keep up the amazing work! üî•";
                    } else if (data.goal_completion_rate >= 60) {
                        statusParagraph.textContent = "Good progress on your financial journey. Stay focused! ‚ú®";
                    } else if (data.goal_completion_rate >= 40) {
                        statusParagraph.textContent = "You're making progress. Consider reviewing your goals and strategies. üëÄ";
                    } else {
                        statusParagraph.textContent = "Time to refocus on your financial goals. You've got this! üí™";
                    }
                }
                
            } catch (error) {
                console.error('Failed to load financial status:', error);
                // Set fallback values
                const sidebarStatusIcon = document.getElementById('sidebar-status-icon');
                const sidebarStatusText = document.getElementById('sidebar-status-text');
                const sidebarGoalsCompleted = document.getElementById('sidebar-goals-completed');
                const sidebarBudgetStatus = document.getElementById('sidebar-budget-status');
                const sidebarRecentActivity = document.getElementById('sidebar-recent-activity');
                
                if (sidebarStatusIcon) sidebarStatusIcon.textContent = 'üìä';
                if (sidebarStatusText) sidebarStatusText.textContent = 'Dashboard';
                if (sidebarGoalsCompleted) sidebarGoalsCompleted.textContent = '-';
                if (sidebarBudgetStatus) sidebarBudgetStatus.textContent = '-';
                if (sidebarRecentActivity) sidebarRecentActivity.textContent = '-';
            }
        }

        // Load financial status on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFinancialStatus();
            
            // Refresh financial status every 30 seconds
            setInterval(loadFinancialStatus, 30000);
        });
    </script>
</body>
</html>